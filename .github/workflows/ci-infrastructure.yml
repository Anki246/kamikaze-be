name: ðŸš€ Kamikaze-be Infrastructure & Deployment

on:
  push:
    branches: [ main, master, dev, develop, cicd-be ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master, dev, develop, cicd-be ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - cicd-be
        - main
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production
      require_approval:
        description: 'Require manual approval before deployment'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  AWS_DEFAULT_REGION: 'us-east-1'
  CACHE_VERSION: 'v1'
  # Application Configuration
  APP_NAME: 'kamikaze-be'
  APP_PORT: '8000'
  SECRETS_NAME: 'kmkz-secrets'

jobs:
  # Job 1: Branch Detection and Environment Setup
  branch-detection:
    name: ðŸ” Branch Detection & Environment Setup
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      requires_approval: ${{ steps.detect.outputs.requires_approval }}
      branch_name: ${{ steps.detect.outputs.branch_name }}
    
    steps:
    - name: ðŸ” Detect branch and set environment
      id: detect
      run: |
        # Get branch name
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BRANCH_NAME="${{ github.event.inputs.target_branch }}"
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          REQUIRES_APPROVAL="${{ github.event.inputs.require_approval }}"
        else
          BRANCH_NAME="${{ github.ref_name }}"
          # Auto-detect environment based on branch
          case "$BRANCH_NAME" in
            "main"|"master")
              ENVIRONMENT="production"
              REQUIRES_APPROVAL="true"
              ;;
            "cicd-be")
              ENVIRONMENT="staging"
              REQUIRES_APPROVAL="true"
              ;;
            "dev"|"develop")
              ENVIRONMENT="development"
              REQUIRES_APPROVAL="false"
              ;;
            *)
              ENVIRONMENT="development"
              REQUIRES_APPROVAL="false"
              ;;
          esac
        fi
        
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "requires_approval=$REQUIRES_APPROVAL" >> $GITHUB_OUTPUT
        
        echo "ðŸŒŸ Branch: $BRANCH_NAME"
        echo "ðŸ—ï¸ Environment: $ENVIRONMENT"
        echo "ðŸ” Requires Approval: $REQUIRES_APPROVAL"

  # Job 2: Manual Approval (for main and cicd-be branches)
  approval:
    name: ðŸ” Manual Approval Required
    runs-on: ubuntu-latest
    needs: branch-detection
    if: needs.branch-detection.outputs.requires_approval == 'true'
    environment: ${{ needs.branch-detection.outputs.environment }}
    
    steps:
    - name: ðŸ” Waiting for manual approval
      run: |
        echo "ðŸ” Manual approval required for deployment to ${{ needs.branch-detection.outputs.environment }}"
        echo "ðŸŒŸ Branch: ${{ needs.branch-detection.outputs.branch_name }}"
        echo "âœ… Approval granted - proceeding with deployment"

  # Job 3: Build and Test
  build-and-test:
    name: ðŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [branch-detection, approval]
    if: always() && (needs.branch-detection.outputs.requires_approval == 'false' || needs.approval.result == 'success')
    environment: ${{ needs.branch-detection.outputs.environment }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov black==23.3.0 isort==5.11.5
        pip install asyncpg psycopg2-binary
    
    - name: ðŸ” Code quality checks
      run: |
        echo "ðŸ” Running code quality checks..."
        black --check --diff .
        isort --check-only --diff .
        python -m py_compile src/api/main.py
        python -m py_compile src/infrastructure/database_config.py
        echo "âœ… Code quality checks passed"
    
    - name: ðŸ§ª Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        python -c "
        import sys
        sys.path.insert(0, 'src')
        
        # Test critical imports
        try:
            from infrastructure.database_config import DatabaseConfig
            print('âœ… Database config import successful')
            
            from infrastructure.aws_secrets_manager import AWSSecretsManager
            print('âœ… AWS Secrets Manager import successful')
            
            print('âœ… All critical imports working')
        except Exception as e:
            print(f'âŒ Import test failed: {e}')
            sys.exit(1)
        "

  # Job 4: Infrastructure Deployment
  deploy-infrastructure:
    name: ðŸš€ Deploy Infrastructure & Application
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [branch-detection, approval, build-and-test]
    if: always() && (needs.branch-detection.outputs.requires_approval == 'false' || needs.approval.result == 'success') && needs.build-and-test.result == 'success'
    environment: ${{ needs.branch-detection.outputs.environment }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: ðŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "~1.0"

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸ“‹ Display GitHub Secrets (for verification)
      run: |
        echo "ðŸ“‹ GitHub Secrets Retrieved (for AWS Secrets Manager):"
        echo "ðŸ” Environment: ${{ needs.branch-detection.outputs.environment }}"
        echo ""
        echo "ðŸ“Š Database Configuration:"
        echo "  DB_HOST: ${DB_HOST:0:20}... (length: ${#DB_HOST})"
        echo "  DB_PORT: $DB_PORT"
        echo "  DB_NAME: $DB_NAME"
        echo "  DB_USER: $DB_USER"
        echo "  DB_PASSWORD: ${DB_PASSWORD:0:3}... (length: ${#DB_PASSWORD})"
        echo ""
        echo "ðŸ”‘ AWS Configuration:"
        echo "  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:10}... (length: ${#AWS_ACCESS_KEY_ID})"
        echo "  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:0:10}... (length: ${#AWS_SECRET_ACCESS_KEY})"
        echo "  AWS_REGION: $AWS_DEFAULT_REGION"
        echo ""
        echo "ðŸ” SSH Configuration:"
        echo "  EC2_SSH_PRIVATE_KEY: Available (length: ${#EC2_SSH_PRIVATE_KEY})"
        echo ""
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

    - name: ðŸš€ Deploy Infrastructure and Application
      env:
        ENVIRONMENT: ${{ needs.branch-detection.outputs.environment }}
        GITHUB_ACTIONS: true
        # Database credentials for Terraform and application
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        # SSH key for EC2 access
        EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      run: |
        echo "ðŸš€ Starting Infrastructure-as-Code Deployment"
        echo "ðŸŒŸ Branch: ${{ needs.branch-detection.outputs.branch_name }}"
        echo "ðŸ—ï¸ Environment: ${{ needs.branch-detection.outputs.environment }}"
        
        # Extract public key from private key
        echo "ðŸ”‘ Setting up SSH keys..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Generate public key from private key
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
        export EC2_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)
        
        # Make deployment script executable
        chmod +x scripts/deploy-with-terraform.sh
        
        # Run infrastructure-as-code deployment
        ./scripts/deploy-with-terraform.sh

    - name: ðŸ¥ Health Check
      run: |
        echo "ðŸ¥ Performing health checks..."
        
        # Get EC2 public IP from Terraform output
        cd infrastructure/terraform
        EC2_PUBLIC_IP=$(terraform output -raw ec2_public_ip 2>/dev/null || echo "3.81.64.108")
        cd - > /dev/null
        
        echo "ðŸŽ¯ Target: http://$EC2_PUBLIC_IP:${{ env.APP_PORT }}"
        
        # Wait for application to start
        echo "â³ Waiting for application to start..."
        sleep 30
        
        # Health check with retries
        for i in {1..10}; do
          echo "ðŸ” Health check attempt $i/10..."
          
          if curl -f "http://$EC2_PUBLIC_IP:${{ env.APP_PORT }}/health" --connect-timeout 10 --max-time 30; then
            echo "âœ… Health check passed"
            break
          else
            echo "â³ Health check failed, retrying in 15 seconds..."
            sleep 15
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ Health checks failed after 10 attempts"
            exit 1
          fi
        done

  # Job 5: Deployment Summary
  deployment-summary:
    name: ðŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [branch-detection, approval, build-and-test, deploy-infrastructure]
    if: always()

    steps:
    - name: ðŸ“‹ Generate Deployment Summary
      run: |
        echo "## ðŸš€ Kamikaze-be Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒŸ Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ needs.branch-detection.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ needs.branch-detection.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Required Approval**: ${{ needs.branch-detection.outputs.requires_approval }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Infrastructure Deployment | ${{ needs.deploy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Application URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Application**: http://3.81.64.108:8000" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: http://3.81.64.108:8000/health" >> $GITHUB_STEP_SUMMARY
        echo "- **API Docs**: http://3.81.64.108:8000/docs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ—ï¸ Infrastructure Features" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Infrastructure-as-Code with Terraform" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AWS Secrets Manager integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Docker containerization" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… RDS database with SSL" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Automated security group management" >> $GITHUB_STEP_SUMMARY
